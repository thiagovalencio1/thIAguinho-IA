<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThIAguinho J.A.R.V.I.S.</title>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a, #2b2c39);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .jarvis-card {
            background: rgba(0, 0, 0, 0.7);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 140, 255, 0.5);
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 30px rgba(0, 140, 255, 0.5); }
            50% { box-shadow: 0 0 60px rgba(0, 140, 255, 0.2); }
        }
        h1 {
            color: #008cff;
            text-align: center;
            margin-bottom: 5px;
        }
        h2 {
            color: #008cff;
            margin-top: 25px;
        }
        button {
            background: #008cff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
            transition: background 0.3s;
        }
        button:hover {
            background: #006bb3;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #008cff;
            background: rgba(0, 0, 0, 0.3);
            color: white;
        }
        .data-card {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .status {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2em;
        }
        .error {
            color: #f44336;
        }
        .jarvis-response {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ThIAguinho J.A.R.V.I.S.</h1>
        <p style="text-align: center;">Seu assistente automotivo inteligente</p>

        <div class="jarvis-card">
            <h2>Conexão com o Carro</h2>
            <button id="connect-btn">Conectar ao ELM327</button>
            <p class="status" id="connection-status">Aguardando conexão...</p>

            <h2>Dados do Veículo</h2>
            <div class="data-card">
                <p>RPM: <span id="rpm">0</span></p>
                <p>Velocidade: <span id="speed">0</span> km/h</p>
                <p>Temperatura: <span id="temperature">0</span> °C</p>
                <p>Código DTC: <span id="dtc">Nenhum</span></p>
            </div>

            <h2>Configuração da IA</h2>
            <input type="password" id="openai-key" placeholder="Insira sua chave da OpenAI">
            <button id="save-key-btn">Salvar Chave</button>
            <p id="key-status" style="color: #4CAF50; display: none;">Chave salva com sucesso!</p>

            <h2>Diagnóstico Automotivo</h2>
            <button id="diagnose-btn" disabled>Gerar Diagnóstico</button>
            <div class="jarvis-response" id="diagnosis">O ThIAguinho analisará seu veículo assim que estiver conectado.</div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let connected = false;
        let device = null;
        let characteristic = null;
        let apiKey = localStorage.getItem('thiaguinho-api-key') || '';

        // Elementos do DOM
        const connectBtn = document.getElementById('connect-btn');
        const connectionStatus = document.getElementById('connection-status');
        const rpmElement = document.getElementById('rpm');
        const speedElement = document.getElementById('speed');
        const temperatureElement = document.getElementById('temperature');
        const dtcElement = document.getElementById('dtc');
        const openaiKeyInput = document.getElementById('openai-key');
        const saveKeyBtn = document.getElementById('save-key-btn');
        const keyStatus = document.getElementById('key-status');
        const diagnoseBtn = document.getElementById('diagnose-btn');
        const diagnosisElement = document.getElementById('diagnosis');

        // Inicialização
        openaiKeyInput.value = apiKey;
        diagnoseBtn.disabled = !apiKey;

        // Função para conectar ao ELM327
        async function connectToCar() {
            try {
                connectionStatus.textContent = 'Procurando dispositivos...';
                connectionStatus.className = 'status';
                
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ 
                        namePrefix: 'OBDII' 
                    }],
                    optionalServices: ['00001101-0000-1000-8000-00805f9b34fb']
                });
                
                connectionStatus.textContent = 'Conectando ao dispositivo...';
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
                characteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');
                
                connected = true;
                connectionStatus.textContent = 'Conectado ao veículo!';
                connectionStatus.className = 'status';
                connectBtn.textContent = 'Desconectar';
                diagnoseBtn.disabled = !apiKey;
                
                // Inicia leitura de dados
                startReadingData();
            } catch (error) {
                connectionStatus.textContent = 'Erro: ' + error.message;
                connectionStatus.className = 'status error';
                connectBtn.textContent = 'Conectar ao ELM327';
                connected = false;
            }
        }

        // Função para desconectar
        function disconnectFromCar() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            connected = false;
            connectBtn.textContent = 'Conectar ao ELM327';
            connectionStatus.textContent = 'Desconectado';
            connectionStatus.className = 'status';
            diagnoseBtn.disabled = true;
        }

        // Função para ler dados do veículo
        async function startReadingData() {
            if (!connected || !characteristic) return;
            
            try {
                // Simula leitura de RPM (substitua com comandos reais do ELM327)
                const rpmCommand = new TextEncoder().encode('010C\r');
                await characteristic.writeValue(rpmCommand);
                await new Promise(resolve => setTimeout(resolve, 100));
                const rpmValue = await characteristic.readValue();
                const rpm = parseRPM(rpmValue);
                rpmElement.textContent = rpm;
                
                // Simula outros dados (substitua com leituras reais)
                speedElement.textContent = Math.floor(Math.random() * 80);
                temperatureElement.textContent = 85 + Math.floor(Math.random() * 10);
                
                // Simula DTCs (substitua com leitura real)
                if (Math.random() > 0.7) {
                    dtcElement.textContent = 'P0171';
                } else {
                    dtcElement.textContent = 'Nenhum';
                }
                
                // Continua lendo a cada 2 segundos
                setTimeout(startReadingData, 2000);
            } catch (error) {
                console.error('Erro na leitura:', error);
                connectionStatus.textContent = 'Erro na comunicação: ' + error.message;
                connectionStatus.className = 'status error';
            }
        }

        // Função para parsear RPM (simplificada)
        function parseRPM(value) {
            const hex = Array.from(new Uint8Array(value.buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            return parseInt(hex, 16) / 4;
        }

        // Função para salvar a chave da OpenAI
        function saveApiKey() {
            apiKey = openaiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('thiaguinho-api-key', apiKey);
                keyStatus.style.display = 'block';
                setTimeout(() => {
                    keyStatus.style.display = 'none';
                }, 2000);
                diagnoseBtn.disabled = false;
            }
        }

        // Função para gerar diagnóstico com IA
        async function generateDiagnosis() {
            if (!apiKey) {
                diagnosisElement.textContent = 'Por favor, insira sua chave da OpenAI primeiro.';
                return;
            }
            
            if (!connected) {
                diagnosisElement.textContent = 'Por favor, conecte-se ao seu veículo primeiro.';
                return;
            }
            
            diagnosisElement.textContent = 'Analisando dados do veículo...';
            
            try {
                const rpm = rpmElement.textContent;
                const speed = speedElement.textContent;
                const temp = temperatureElement.textContent;
                const dtc = dtcElement.textContent;
                
                const prompt = `Você é o ThIAguinho, assistente mecânico inteligente estilo J.A.R.V.I.S.\n\n` +
                    `Dados do veículo:\n` +
                    `- RPM: ${rpm}\n` +
                    `- Velocidade: ${speed} km/h\n` +
                    `- Temperatura: ${temp} °C\n` +
                    `- Código DTC: ${dtc}\n\n` +
                    `Analise esses dados e responda em português do Brasil:\n` +
                    `1. Causa mais provável do problema\n` +
                    `2. Próximos passos para diagnóstico\n` +
                    `3. Soluções possíveis\n` +
                    `4. Nível de urgência (baixo, médio, alto)\n` +
                    `5. Custo estimado (se possível)\n\n` +
                    `Responda como se fosse o J.A.R.V.I.S. do Homem de Ferro, com um tom profissional e amigável.`;
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 300,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error.message || 'Erro na API da OpenAI');
                }
                
                const data = await response.json();
                diagnosisElement.textContent = data.choices[0].message.content;
            } catch (error) {
                diagnosisElement.textContent = `Erro: ${error.message}\n\n` +
                    `Verifique:\n` +
                    `1. Sua chave da OpenAI está correta\n` +
                    `2. Você tem créditos disponíveis\n` +
                    `3. Sua conexão com a internet está funcionando`;
                console.error('Erro no diagnóstico:', error);
            }
        }

        // Event listeners
        connectBtn.addEventListener('click', () => {
            if (connected) {
                disconnectFromCar();
            } else {
                connectToCar();
            }
        });

        saveKeyBtn.addEventListener('click', saveApiKey);

        diagnoseBtn.addEventListener('click', generateDiagnosis);

        // Se já temos uma chave salva, atualiza o status
        if (apiKey) {
            keyStatus.style.display = 'block';
            setTimeout(() => {
                keyStatus.style.display = 'none';
            }, 2000);
        }
    </script>
</body>
</html>
