<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThIAguinho J.A.R.V.I.S.</title>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a, #2b2c39);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .jarvis-card {
            background: rgba(0, 0, 0, 0.7);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 140, 255, 0.5);
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 30px rgba(0, 140, 255, 0.5); }
            50% { box-shadow: 0 0 60px rgba(0, 140, 255, 0.2); }
        }
        h1 {
            color: #008cff;
            text-align: center;
            margin-bottom: 5px;
        }
        h2 {
            color: #008cff;
            margin-top: 25px;
        }
        button {
            background: #008cff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
            transition: background 0.3s;
        }
        button:hover {
            background: #006bb3;
        }
        .data-card {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .status {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2em;
        }
        .error {
            color: #f44336;
        }
        .jarvis-response {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ThIAguinho J.A.R.V.I.S.</h1>
        <p style="text-align: center;">Seu assistente automotivo inteligente</p>

        <div class="jarvis-card">
            <h2>Conexão com o Carro</h2>
            <p class="status" id="connection-status">Tentando conexão automática...</p>

            <h2>Dados do Veículo</h2>
            <div class="data-card">
                <p>RPM: <span id="rpm">0</span></p>
                <p>Velocidade: <span id="speed">0</span> km/h</p>
                <p>Temperatura: <span id="temperature">0</span> °C</p>
                <p>Código DTC: <span id="dtc">Nenhum</span></p>
            </div>

            <h2>Diagnóstico Automotivo</h2>
            <button id="diagnose-btn" disabled>Gerar Diagnóstico</button>
            <div class="jarvis-response" id="diagnosis">Aguardando conexão com o veículo...</div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let connected = false;
        let device = null;
        let characteristic = null;
        const apiKey = "AIzaSyDlxSD-8SzZUmAIcqxbyb9Sup64C5AVHxo"; // Chave do Google API pré-configurada

        // Elementos do DOM
        const connectionStatus = document.getElementById('connection-status');
        const rpmElement = document.getElementById('rpm');
        const speedElement = document.getElementById('speed');
        const temperatureElement = document.getElementById('temperature');
        const dtcElement = document.getElementById('dtc');
        const diagnoseBtn = document.getElementById('diagnose-btn');
        const diagnosisElement = document.getElementById('diagnosis');

        // Conecta automaticamente ao carregar a página
        async function autoConnect() {
            try {
                connectionStatus.textContent = 'Procurando dispositivo CHX...';
                connectionStatus.className = 'status';
                
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ 
                        name: 'CHX',
                        addresses: ['00:12:06:29:35:25']
                    }],
                    optionalServices: ['00001101-0000-1000-8000-00805f9b34fb']
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
                characteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');
                
                connected = true;
                connectionStatus.textContent = 'Conectado ao veículo!';
                connectionStatus.className = 'status';
                diagnoseBtn.disabled = false;
                
                // Inicia leitura de dados
                startReadingData();
            } catch (error) {
                connectionStatus.textContent = 'Erro: ' + error.message;
                connectionStatus.className = 'status error';
                connected = false;
                setTimeout(autoConnect, 5000); // Tenta reconectar a cada 5 segundos
            }
        }

        // Função para ler dados do veículo
        async function startReadingData() {
            if (!connected || !characteristic) return;
            
            try {
                // Comando para ler RPM (010C)
                const rpmCommand = new TextEncoder().encode('010C\r');
                await characteristic.writeValue(rpmCommand);
                await new Promise(resolve => setTimeout(resolve, 100));
                const rpmValue = await characteristic.readValue();
                const rpm = parseRPM(rpmValue);
                rpmElement.textContent = rpm;
                
                // Comando para ler velocidade (010D)
                const speedCommand = new TextEncoder().encode('010D\r');
                await characteristic.writeValue(speedCommand);
                await new Promise(resolve => setTimeout(resolve, 100));
                const speedValue = await characteristic.readValue();
                const speed = parseSpeed(speedValue);
                speedElement.textContent = speed;
                
                // Comando para ler temperatura (0105)
                const tempCommand = new TextEncoder().encode('0105\r');
                await characteristic.writeValue(tempCommand);
                await new Promise(resolve => setTimeout(resolve, 100));
                const tempValue = await characteristic.readValue();
                const temp = parseTemperature(tempValue);
                temperatureElement.textContent = temp;
                
                // Comando para ler DTCs (03)
                const dtcCommand = new TextEncoder().encode('03\r');
                await characteristic.writeValue(dtcCommand);
                await new Promise(resolve => setTimeout(resolve, 100));
                const dtcValue = await characteristic.readValue();
                const dtc = parseDTC(dtcValue);
                dtcElement.textContent = dtc || 'Nenhum';
                
                // Continua lendo a cada 2 segundos
                setTimeout(startReadingData, 2000);
            } catch (error) {
                console.error('Erro na leitura:', error);
                connectionStatus.textContent = 'Erro na comunicação: ' + error.message;
                connectionStatus.className = 'status error';
            }
        }

        // Funções para parsear dados
        function parseRPM(value) {
            const hex = Array.from(new Uint8Array(value.buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            return parseInt(hex, 16) / 4;
        }

        function parseSpeed(value) {
            const hex = Array.from(new Uint8Array(value.buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            return parseInt(hex, 16);
        }

        function parseTemperature(value) {
            const hex = Array.from(new Uint8Array(value.buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            return parseInt(hex, 16) - 40;
        }

        function parseDTC(value) {
            const hex = Array.from(new Uint8Array(value.buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
            return hex.startsWith('43') ? 'P' + hex.slice(2) : '';
        }

        // Função para gerar diagnóstico com Google API
        async function generateDiagnosis() {
            if (!connected) {
                diagnosisElement.textContent = 'Por favor, conecte-se ao seu veículo primeiro.';
                return;
            }
            
            diagnosisElement.textContent = 'Analisando dados do veículo...';
            
            try {
                const rpm = rpmElement.textContent;
                const speed = speedElement.textContent;
                const temp = temperatureElement.textContent;
                const dtc = dtcElement.textContent;
                
                const prompt = `Você é o ThIAguinho, assistente mecânico inteligente estilo J.A.R.V.I.S.\n\n` +
                    `Dados do veículo:\n` +
                    `- RPM: ${rpm}\n` +
                    `- Velocidade: ${speed} km/h\n` +
                    `- Temperatura: ${temp} °C\n` +
                    `- Código DTC: ${dtc}\n\n` +
                    `Analise esses dados e responda em português do Brasil:\n` +
                    `1. Causa mais provável do problema\n` +
                    `2. Próximos passos para diagnóstico\n` +
                    `3. Soluções possíveis\n` +
                    `4. Nível de urgência (baixo, médio, alto)\n` +
                    `5. Custo estimado (se possível)\n\n` +
                    `Responda como se fosse o J.A.R.V.I.S. do Homem de Ferro, com um tom profissional e amigável.`;
                
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + apiKey, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [
                            { parts: [{ text: prompt }] }
                        ]
                    })
                });
                
                const data = await response.json();
                diagnosisElement.textContent = data.candidates[0].content.parts[0].text;
            } catch (error) {
                diagnosisElement.textContent = `Erro: ${error.message}\n\n` +
                    `Verifique:\n` +
                    `1. Seu adaptador Bluetooth está ligado\n` +
                    `2. Sua conexão com a internet está funcionando`;
                console.error('Erro no diagnóstico:', error);
            }
        }

        // Event listeners
        diagnoseBtn.addEventListener('click', generateDiagnosis);

        // Inicia conexão automática
        autoConnect();
    </script>
</body>
</html>
