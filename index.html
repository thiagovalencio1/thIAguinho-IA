<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThIAguinho J.A.R.V.I.S.</title>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a, #2b2c39);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .jarvis-card {
            background: rgba(0, 0, 0, 0.7);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 140, 255, 0.5);
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 30px rgba(0, 140, 255, 0.5); }
            50% { box-shadow: 0 0 60px rgba(0, 140, 255, 0.2); }
        }
        button {
            background: #008cff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
            transition: background 0.3s;
        }
        button:hover {
            background: #006bb3;
        }
        .status {
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2em;
        }
        .error {
            color: #f44336;
        }
        .jarvis-response {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ThIAguinho J.A.R.V.I.S.</h1>
        <p style="text-align: center;">Seu assistente automotivo inteligente</p>

        <div class="jarvis-card">
            <button id="scan-btn" onclick="startContinuousScan()">Procurar ELM327 Continuamente</button>
            <p class="status" id="connection-status">Tentando conexão automática...</p>

            <div class="data-card">
                <p>RPM: <span id="rpm">0</span></p>
                <p>Velocidade: <span id="speed">0</span> km/h</p>
                <p>Temperatura: <span id="temperature">0</span> °C</p>
                <p>Código DTC: <span id="dtc">Nenhum</span></p>
            </div>

            <button id="diagnose-btn" disabled onclick="generateDiagnosis()">Gerar Diagnóstico</button>
            <div class="jarvis-response" id="diagnosis"></div>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyDlxSD-8SzZUmAIcqxbyb9Sup64C5AVHxo"; // Chave do Google API
        let connected = false;
        let device, characteristic;
        let scanInterval;

        // Inicialização automática
        document.addEventListener('DOMContentLoaded', () => {
            startContinuousScan();
        });

        // Função para procurar continuamente o ELM327
        async function startContinuousScan() {
            if (scanInterval) return;
            
            scanInterval = setInterval(async () => {
                try {
                    document.getElementById('connection-status').textContent = 'Procurando ELM327...';
                    device = await navigator.bluetooth.requestDevice({
                        filters: [{ 
                            services: ['00001101-0000-1000-8000-00805f9b34fb'] 
                        }],
                        optionalServices: ['00001101-0000-1000-8000-00805f9b34fb']
                    });

                    clearInterval(scanInterval);
                    scanInterval = null;
                    
                    const server = await device.gatt.connect();
                    const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
                    characteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');
                    
                    // Comandos de inicialização (como o Torque Pro)
                    await sendCommand('ATZ'); // Reinicia o ELM327
                    await sendCommand('ATE0'); // Desativa eco
                    await sendCommand('ATSP0'); // Protocolo automático
                    
                    connected = true;
                    document.getElementById('connection-status').textContent = 'Conectado!';
                    document.getElementById('connection-status').classList.add('status');
                    document.getElementById('diagnose-btn').disabled = false;
                    
                    startReadingData();
                } catch (error) {
                    document.getElementById('connection-status').textContent = 'Erro: ' + error.message;
                    document.getElementById('connection-status').classList.add('error');
                }
            }, 5000);
        }

        // Função para enviar comandos ao ELM327
        async function sendCommand(cmd) {
            if (!connected) return;
            const encoder = new TextEncoder();
            await characteristic.writeValue(encoder.encode(cmd + '\r'));
            await new Promise(resolve => setTimeout(resolve, 100));
            const value = await characteristic.readValue();
            return new TextDecoder().decode(value.buffer);
        }

        // Função para ler dados continuamente
        async function startReadingData() {
            if (!connected) return;
            
            try {
                // Lê RPM (010C)
                const rpmResponse = await sendCommand('010C');
                document.getElementById('rpm').textContent = parseRPM(rpmResponse);
                
                // Lê velocidade (010D)
                const speedResponse = await sendCommand('010D');
                document.getElementById('speed').textContent = parseSpeed(speedResponse);
                
                // Lê temperatura (0105)
                const tempResponse = await sendCommand('0105');
                document.getElementById('temperature').textContent = parseTemperature(tempResponse);
                
                // Lê DTCs (03)
                const dtcResponse = await sendCommand('03');
                document.getElementById('dtc').textContent = parseDTC(dtcResponse) || 'Nenhum';
                
                setTimeout(startReadingData, 2000);
            } catch (error) {
                document.getElementById('connection-status').textContent = 'Erro na leitura: ' + error.message;
                document.getElementById('connection-status').classList.add('error');
                connected = false;
                startContinuousScan(); // Reinicia a procura
            }
        }

        // Funções para parsear respostas
        function parseRPM(response) {
            const hex = response.split(' ').slice(2).join('');
            return parseInt(hex, 16) / 4;
        }

        function parseSpeed(response) {
            const hex = response.split(' ').slice(2).join('');
            return parseInt(hex, 16);
        }

        function parseTemperature(response) {
            const hex = response.split(' ').slice(2).join('');
            return parseInt(hex, 16) - 40;
        }

        function parseDTC(response) {
            const codes = response.match(/4300[0-9A-F]{4}/g);
            return codes ? codes.map(code => 'P' + code.slice(4)).join(', ') : null;
        }

        // Função para gerar diagnóstico com Google Gemini
        async function generateDiagnosis() {
            const rpm = document.getElementById('rpm').textContent;
            const speed = document.getElementById('speed').textContent;
            const temp = document.getElementById('temperature').textContent;
            const dtc = document.getElementById('dtc').textContent;

            const prompt = `Veículo com:\n- RPM: ${rpm}\n- Velocidade: ${speed} km/h\n- Temperatura: ${temp} °C\n- Código DTC: ${dtc}\n\nAnalise como o J.A.R.V.I.S. do Homem de Ferro.`;
            
            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                document.getElementById('diagnosis').textContent = data.candidates[0].content.parts[0].text;
            } catch (error) {
                document.getElementById('diagnosis').textContent = 'Erro na IA: ' + error.message;
            }
        }
    </script>
</body>
</html>
